version: '3.8'

# =============================================================================
# RAG Pipeline Docker Compose Configuration
# =============================================================================
# This compose file orchestrates all services in the RAG pipeline
# All services share the same .env file located in the services folder
#
# Usage:
#   1. Copy .env.example to .env and fill in your values
#   2. Run: docker-compose up -d
#   3. Access gateway at http://localhost:8100
#   4. Access internal testing UI at http://localhost:3001
#
# Services:
#   - gateway-service (Port 8100) - Main entry point [EXPOSED]
#   - internal-service (Port 3001) - Internal testing UI [EXPOSED]
#   - query-optimizer-service (Port 5000) - Internal only
#   - embed-service (Port 4000) - Internal only
#   - search-service (Port 3000) - Internal only
#   - ask-service (Port 2000) - Internal only
#   - scrape-service (Port 3000) - Internal only
#   - split-service (Port 3000) - Internal only
#   - match-service (Port 3000) - Internal only
#
# Security: Only gateway and internal-service are exposed to host.
# Internal-service communicates with other services via Docker network.
# =============================================================================

services:
  # ===========================================================================
  # GATEWAY SERVICE - Main Entry Point
  # ===========================================================================
  gateway:
    build:
      context: ./gateway-service
      dockerfile: Dockerfile
    container_name: gateway-service
    ports:
      - "8100:8000"
    env_file:
      - .env
    environment:
      # Override service URLs for container networking
      - QUERY_OPTIMIZER_URL=http://query-optimizer:5000
      - EMBED_SERVICE_URL=http://embed-service:4000
      - SEARCH_SERVICE_URL=http://search-service:3000
      - ASK_SERVICE_URL=http://ask-service:2000
    depends_on:
      query-optimizer:
        condition: service_started
      embed-service:
        condition: service_started
      search-service:
        condition: service_started
      ask-service:
        condition: service_started
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # QUERY OPTIMIZER SERVICE
  # ===========================================================================
  query-optimizer:
    build:
      context: ./query-optimizer-service
      dockerfile: Dockerfile
    container_name: query-optimizer-service
    expose:
      - "5000"
    env_file:
      - .env
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # EMBED SERVICE
  # ===========================================================================
  embed-service:
    build:
      context: ./embed-service
      dockerfile: Dockerfile
    container_name: embed-service
    expose:
      - "4000"
    env_file:
      - .env
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # SEARCH SERVICE
  # ===========================================================================
  search-service:
    build:
      context: ./search-service
      dockerfile: Dockerfile
    container_name: search-service
    expose:
      - "3000"
    env_file:
      - .env
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================================================
  # ASK SERVICE
  # ===========================================================================
  ask-service:
    build:
      context: ./ask-service
      dockerfile: Dockerfile
    container_name: ask-service
    expose:
      - "2000"
    env_file:
      - .env
    volumes:
      # Mount system instruction file
      - ./ask-service/system_instruction.txt:/app/system_instruction.txt:ro
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:2000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # SCRAPE SERVICE - Book scraping and processing
  # ===========================================================================
  scrape-service:
    build:
      context: ./scrape-service
      dockerfile: Dockerfile
    container_name: scrape-service
    expose:
      - "3000"
    env_file:
      - .env
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # SPLIT SERVICE - Semantic text chunking
  # ===========================================================================
  split-service:
    build:
      context: ./split-service
      dockerfile: Dockerfile
    container_name: split-service
    expose:
      - "3000"
    env_file:
      - .env
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # MATCH SERVICE - Chunk to page range matching
  # ===========================================================================
  match-service:
    build:
      context: ./match-service
      dockerfile: Dockerfile
    container_name: match-service
    expose:
      - "3000"
    env_file:
      - .env
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # BOOKS DB SERVICE - Book metadata and export
  # ===========================================================================
  books-db-service:
    build:
      context: ./books-db-service
      dockerfile: Dockerfile
    container_name: books-db-service
    ports:
      - "4001:4000"
    env_file:
      - .env
    volumes:
      # Mount shamela4 directory (12GB - too large to copy into image)
      - ./books-db-service/shamela4:/app/shamela4:ro
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # INTERNAL SERVICE - Testing UI
  # ===========================================================================
  internal-service:
    build:
      context: ./internal-service
      dockerfile: Dockerfile
    container_name: internal-service
    ports:
      - "3001:3001"
    environment:
      - DOCKER_ENV=true
    depends_on:
      gateway:
        condition: service_healthy
      query-optimizer:
        condition: service_started
      embed-service:
        condition: service_started
      search-service:
        condition: service_started
      ask-service:
        condition: service_started
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  rag-network:
    driver: bridge
    name: rag-network
